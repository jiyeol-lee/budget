# =============================================================================
# nginx.conf - Budget Tracker Reverse Proxy Configuration
# =============================================================================
# This configuration:
# - Serves static frontend files from /app/frontend/build
# - Proxies /api/* requests to Go backend on port 8080
# - Proxies /health to backend for health checks
# - Implements SPA fallback for client-side routing
# =============================================================================

# Worker processes - auto-detect CPU cores
worker_processes auto;

# Log errors to stderr for Docker logging
error_log /dev/stderr warn;

# PID file location (writable by non-root user)
pid /run/nginx/nginx.pid;

# =============================================================================
# Events Configuration
# =============================================================================
events {
    # Maximum simultaneous connections per worker
    worker_connections 1024;

    # Use epoll for better performance on Linux
    use epoll;

    # Accept multiple connections at once
    multi_accept on;
}

# =============================================================================
# HTTP Configuration
# =============================================================================
http {
    # MIME type mappings
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Optimize file serving
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    # Connection keepalive settings
    keepalive_timeout 65;

    # Hide nginx version for security
    server_tokens off;

    # =========================================================================
    # Logging Configuration
    # =========================================================================
    # JSON format for structured logging (easy parsing by log aggregators)
    log_format json_combined escape=json '{'
        '"time":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"method":"$request_method",'
        '"uri":"$request_uri",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"request_time":$request_time,'
        '"user_agent":"$http_user_agent"'
    '}';

    # Output access logs to stdout for Docker
    access_log /dev/stdout json_combined;

    # =========================================================================
    # Gzip Compression
    # =========================================================================
    # Compress responses to reduce bandwidth
    gzip on;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_min_length 256;
    gzip_types
        text/plain
        text/css
        text/javascript
        application/json
        application/javascript
        image/svg+xml;

    # =========================================================================
    # Upstream Backend
    # =========================================================================
    # Go backend server running on localhost port 8080
    upstream backend {
        server 127.0.0.1:8080;

        # Keep connections alive for better performance
        keepalive 32;
    }

    # =========================================================================
    # Server Configuration
    # =========================================================================
    server {
        # Listen on port 3000 (non-privileged, no root required)
        listen 3000 default_server;
        listen [::]:3000 default_server;
        server_name _;

        # Root directory for static frontend files
        root /app/frontend/build;
        index index.html;

        # Maximum upload size (for receipt images)
        client_max_body_size 10M;

        # =====================================================================
        # Security Headers (applied to all responses)
        # =====================================================================
        # Prevent MIME type sniffing
        add_header X-Content-Type-Options "nosniff" always;

        # Prevent clickjacking
        add_header X-Frame-Options "SAMEORIGIN" always;

        # Control referrer information
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # =====================================================================
        # Health Check Endpoint
        # =====================================================================
        # Proxied to backend for container health checks
        location = /health {
            proxy_pass http://backend/health;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;

            # Don't log health checks (reduces log noise)
            access_log off;
        }

        # =====================================================================
        # API Endpoints
        # =====================================================================
        # All /api/* requests are proxied to the Go backend
        location /api/ {
            proxy_pass http://backend;
            proxy_http_version 1.1;

            # Connection reuse for performance
            proxy_set_header Connection "";

            # Preserve original request information
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Timeouts (longer for AI receipt processing which can take time)
            proxy_connect_timeout 10s;
            proxy_send_timeout 120s;
            proxy_read_timeout 120s;

            # Buffering settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 16k;

            # Security headers (must repeat as add_header in location overrides parent)
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;

            # Prevent caching of API responses
            add_header Cache-Control "no-store, no-cache, must-revalidate" always;
        }

        # =====================================================================
        # Static Assets - Immutable (hashed filenames)
        # =====================================================================
        # Cache for 1 year - these files have content hashes in filenames
        location ~* \.(js|css|woff|woff2|ttf|eot|ico)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            try_files $uri =404;
        }

        # =====================================================================
        # Static Assets - Images
        # =====================================================================
        # Cache for 1 week
        location ~* \.(jpg|jpeg|png|gif|svg|webp)$ {
            expires 7d;
            add_header Cache-Control "public";
            try_files $uri =404;
        }

        # =====================================================================
        # SPA Fallback
        # =====================================================================
        # Try to serve file, then directory, then fallback to index.html
        # This enables client-side routing for the SvelteKit SPA
        location / {
            try_files $uri $uri/ /index.html;
        }
    }
}
